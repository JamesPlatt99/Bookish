@using Bookish.Web.Controllers
@using DataAccessNew
@using Bookish.Web.Models
@using Bookish.Web.ViewModels
@using DataAccessNew.Tables
@model Bookish.Web.ViewModels.UserData
@{
    HomeController homeController = new HomeController();
    if (Session["userName"] == null && Session["password"] == null)
    {
        if (homeController.ValidateUser(@Model))
        {
            Session["userName"] = @Model.User.userName;
            Session["password"] = @Model.User.passwordHash;
        }
    }
}
<!DOCTYPE html>
<html>
<head>
    <title>Home</title>
</head>

<body>
    <div>
        <br />
        <h3>
            Welcome @Session["UserName"]
        </h3>
    </div>
    <div style="float: left; width: 400px;">
        <h2>Menu</h2>
        <br />
        <a href="Library">View library</a>
        <br /><br />
        <a href="AddBook">Add book.</a>
        <br /><br />
        <a href="RentalHistory">View previous rentals.</a>
    </div>
    @{
        UserRepository userRepository = new UserRepository();
        int userId = userRepository.GetSingleUser(Session["userName"].ToString()).id;
        LoanRepository loanRepository = new LoanRepository();
        List<Loans> rentals = loanRepository.GetActiveLoans(userId);
    }
    <div style="overflow: hidden;">
        <h2>Current rentals</h2>
        <table cellpadding="10">
            <tr style="background-color: #a9a9a9">
                <td>
                    <b>
                        Cover Image:
                    </b>
                </td>
                <td>
                    <b>
                        Book title:
                    </b>
                </td>
                <td>
                    <b>
                        Author:
                    </b>
                </td>
                <td>
                    <b>
                        Taken out:
                    </b>
                </td>
                <td>
                    <b>
                        Due back:
                    </b>
                </td>
                <td>
                    <b>
                        Return:
                    </b>
                </td>
            </tr>
            @{
                int i = 0;
                foreach (Loans rental in rentals)
                {
                    i++;
                    string style = "background-color: #44dd44;";
                    if (i % 2 == 0)
                    {
                        style = "background-color: #55cc55;";
                    }
                    if (DateTime.Compare(rental.dateTakenOut.AddDays(rental.duration), DateTime.Now.Date) < 0)
                    {
                        style = "background-color: #dd4444;";
                        if (i % 2 == 0)
                        {
                            style = "background-color: #cc5555;";
                        }
                    }
                    if (DateTime.Compare(rental.dateTakenOut.AddDays(rental.duration), DateTime.Now.Date) == 0)
                    {
                        style = "background-color: #dddd44;";
                        if (i % 2 == 0)
                        {
                            style = "background-color: #cccc55;";
                        }
                    }
                    <tr style="@style height: 100px;">
                        <td>
                            <img src="@rental.Book.BookType.coverImageURL" height="100px" />
                        </td>
                        <td>
                            @rental.Book.BookType.title
                        </td>
                        <td>
                            @rental.Book.BookType.author.name
                        </td>
                        <td>
                            @string.Format($"{rental.dateTakenOut:d}")
                        </td>
                        <td>
                            @string.Format($"{rental.dateTakenOut.AddDays(rental.duration):d}")
                        </td>
                        <td>
                            <a href="ReturnBook?rentalId=@rental.id">Mark as returned</a>
                        </td>
                    </tr>
                }
            }
        </table>
    </div>
</body>
</html>